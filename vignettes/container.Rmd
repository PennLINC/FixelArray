---
title: "Getting started with container"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting started with container}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Preface
Target audience: Any user who wants to use container to run `ModelArray` and/or `ConFixel` on e.g., High Performance Computing (HPC) clusters. 

What are covered in this page? How to use the container of `ModelArray + ConFixel`.

What are not covered in this page? Details on how to use `ModelArray` or `ConFixel`. For those, please refer to `vignette("walkthrough")`. We highly suggest reading it if you're new to `ModelArray`.


## Introduction
Besides running `ModelArray` and `ConFixel` on a local computer, users also have an option to run it on HPC clusters. When using HPC clusters, users may not have full privilege to install all the dependent packages. Therefore, we also provide a container that includes `ModelArray + ConFixel` to enhance portability and to facilitate running on clusters.

The container image is publicly available at [Docker Hub](https://hub.docker.com/r/pennlinc/modelarray_confixel). You might be confused at first because usually HPC clusters do not support `docker` commands, however, this container image can be run with `singularity` commands which are usually available on HPC clusters (see below for details).

## Using singularity to run on HPC clusters
Prerequisite: Singularity installed HCP clusters. If not, please contact the HPC's administrator.

### Pull the container from Docker Hub
We first pull the container from Docker Hub using `singularity pull`:

```{.console}
singularity pull docker://pennlinc/modelarray_confixel:<tagName>
```
You may replace the `<tagName>` to any tags, e.g., `0.1.2`, or `latest`, etc. You should see a singularity image (`.sif`) in current directory: `modelarray_confixel_<tagName>.sif`

After pulling, let's make sure it's success:
```{.console}
singularity run --cleanenv \
    modelarray_confixel_<tagName>.sif \
    R
```

You should have entered an R environment. You should be able to load `ModelArray` R package as you usually do in RStudio: `library(ModelArray)`. This is also the way to interactively use this container image to run R.

### How to run the container?
```{.console}
singularity run --cleanenv -B /directory/of/your/data \
  /path/to/singularity/image/modelarray_confixel_<tagName>.sif \
  <commands you want to run>
```

Here,

* `-B /directory/of/your/data` means to mount the data directory, so that `singularity` can read and write data in it. If you're data is in the current directory, you might do `-B $PWD`;
* `/path/to/singularity/image/modelarray_confixel_<tagName>.sif` is the full path to the singularity image (`.sif`) you pulled;

Regarding `<commands you want to run>`: As both `ModelArray` and `ConFixel` are included in this container, you might run any of them. To run `ModelArray`, you may first save the R commands into an R script, then replace `<commands you want to run>` with `Rscript /path/to/your/Rscript`. Make sure this Rscript has been mounted (`-B`), too, e.g., If it's not in the directory `/directory/of/your/data`, please do: `-B /directory/of/your/data,/directory/of/Rscript`.

You might submit this command `singluarity run` as a job running on the cluster compute node. Please consult the cluster's manual for how to do it.

## More information?
We have provided a detailed example walkthrough of `ModelArray` and `ConFixel`at: `vignette("walkthrough")`. Please refer to it for how to run `ModelArray` and `ConFixel`.

